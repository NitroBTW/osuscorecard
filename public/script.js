let currentScoreData=null,currentMapData=null,gradientCanvas=null,gradientCtx=null,smallScorecard=!1;function extractCssBackgroundUrl(e){if(!e||"none"===e)return"";const t=e.match(/url\(['"]?([^'"]+)['"]?\)/);return t?t[1]:""}async function fetchImageAsDataUrl(e){const t=e+(e.includes("?")?"&":"?")+`_dl=${Date.now()}`,a=await fetch(t,{cache:"no-store"});if(!a.ok)throw new Error(`Failed to fetch image: ${a.status}`);const n=await a.blob();return await new Promise((e,t)=>{const a=new FileReader;a.onloadend=()=>e(a.result),a.onerror=t,a.readAsDataURL(n)})}async function applyBackgroundDataUrl(e,t,a){try{const a=e.querySelector(".background-image img.bg-img");if(!a)return;const n=await fetchImageAsDataUrl(t);a.src=n}catch(e){console.warn(a,"failed to apply bg data URL",e)}}async function applyAvatarDataUrl(e,t,a){try{const a=e.querySelector(".avatar-container img.avatar");if(!a)return;const n=await fetchImageAsDataUrl(t);a.src=n}catch(e){console.warn(a,"failed to apply avatar data URL",e)}}async function loadGradientColours(){try{const e=new Image;return e.crossOrigin="anonymous",new Promise((t,a)=>{e.onload=function(){const a=document.createElement("canvas"),n=a.getContext("2d");a.width=e.width,a.height=e.height,n.drawImage(e,0,0),gradientCanvas=a,gradientCtx=n,t()},e.onerror=function(){console.error("Could not load gradient image"),a(new Error("Failed to load gradient"))},e.src="gradient.png"})}catch(e){throw console.error("Could not load gradient:",e),e}}function getGradientColour(e){if(!gradientCanvas||!gradientCtx){return{0:"#666666",1:"#4FC3F7",2:"#4CAF50",3:"#FFEB3B",4:"#FF9800",5:"#FF5722",6:"#E91E63",7:"#9C27B0",8:"#673AB7",9:"#3F51B5",10:"#000000"}[Math.min(Math.floor(e),10)]||"#ff6b6b"}const t=Math.max(0,Math.min(10,e))/10,a=Math.floor(t*(gradientCanvas.width-1)),n=Math.floor(gradientCanvas.height/2);try{const e=gradientCtx.getImageData(a,n,1,1).data;return`#${e[0].toString(16).padStart(2,"0")}${e[1].toString(16).padStart(2,"0")}${e[2].toString(16).padStart(2,"0")}`}catch(e){return console.error("Error sampling gradient:",e),"#ff6b6b"}}function formatScore(e){return e.toLocaleString()}function formatAccuracy(e){return(100*e).toFixed(2)}function generateModIconsHtml(e){return e&&0!==e.length?e.map(e=>`<div class="mod-icon" style="background-image: url('./icons/${e.acronym}.png')"></div>`).join(""):""}function truncateText(e,t){return e.length>t?e.substring(0,t-2)+"..":e}function getProxiedImageUrl(e,t){return t?`/api/proxy-image/${e}?url=${encodeURIComponent(t)}`:""}async function updateCounterDisplay(){const e=await fetch("/api/scorecards/count"),t=await e.json();document.getElementById("scorecard-count").innerText=`Scorecards generated: ${t.count}`}async function fetchMapData(e){try{setStatus("Loading map data...","loading");const t=await fetch(`/api/map/${e}`);if(!t.ok)throw new Error("Failed to fetch map data! Make sure you entered a valid ID or URL. If this error persists, report it on the github page!");const a=await t.json();currentMapData=a,currentScoreData=null;document.getElementById("scoreOverrides").style.display="block";const n=document.getElementById("ppInputGroup");"loved"===a.beatmap.status?n.style.display="block":n.style.display="none",updateScorecard(),setStatus("Map loaded successfully!","success")}catch(e){console.error("Error fetching map:",e),setStatus(`Error: ${e.message}`,"error"),currentMapData=null,document.getElementById("scorecard-preview").style.display="none",document.getElementById("placeholder").style.display="block",document.getElementById("scoreOverrides").style.display="none",document.getElementById("saveBtn").disabled=!0}}function extractScoreData(){const e=getScoreOverrides();if(currentScoreData){const t=currentScoreData;return{score:""!==e.score?parseInt(e.score):t.lazer?t.score.score:t.score.classic_score,classic_score:""!==e.score?parseInt(e.score):t.score.classic_score,c300:""!==e.count300?parseInt(e.count300):t.score.c300,c100:""!==e.count100?parseInt(e.count100):t.score.c100,c50:""!==e.count50?parseInt(e.count50):t.score.c50,misses:""!==e.countMiss?parseInt(e.countMiss):t.score.misses,cEnds:""!==e.countSliderEnds?parseInt(e.countSliderEnds):t.score.cEnds,max_combo:""!==e.combo?parseInt(e.combo):t.score.max_combo,accuracy:""!==e.accuracy?parseFloat(e.accuracy)/100:t.score.accuracy,pp:""!==e.pp?parseFloat(e.pp):t.score.pp,rank:""!==e.rank?e.rank:t.score.rank,mods:""!==e.mods?parseModsString(e.mods):t.score.mods,leaderboard:""!==e.leaderboard?parseInt(e.leaderboard):t.score.leaderboard,full_combo:t.score.full_combo,cSliders:t.score.cSliders}}return currentMapData?{score:""!==e.score?parseInt(e.score):0,c300:""!==e.count300?parseInt(e.count300):0,c100:""!==e.count100?parseInt(e.count100):0,c50:""!==e.count50?parseInt(e.count50):0,misses:""!==e.countMiss?parseInt(e.countMiss):0,cEnds:""!==e.countSliderEnds?parseInt(e.countSliderEnds):0,cSliders:100,max_combo:""!==e.combo?parseInt(e.combo):0,accuracy:""!==e.accuracy?parseFloat(e.accuracy)/100:0,pp:""!==e.pp?parseFloat(e.pp):0,rank:""!==e.rank?e.rank:"F",mods:""!==e.mods?parseModsString(e.mods):[],leaderboard:""!==e.leaderboard?parseInt(e.leaderboard):0,full_combo:!1}:null}function extractUserData(){const e=getUserOverrides();if(currentScoreData){const t=currentScoreData;return{username:""!==e.username?e.username:t.user.username,userRank:""!==e.userRank?parseInt(e.userRank):t.user.user_rank,avatarUrl:""!==e.avatarUrl?e.avatarUrl:t.user.avatar_url,country:t.user.country}}if(currentMapData){const t="https://osu.ppy.sh/images/layout/avatar-guest.png";return{username:e.username||"Guest",userRank:e.userRank||0,avatarUrl:e.avatarUrl||t,country:"xx"}}return null}function getBeatmapData(){return currentScoreData?currentScoreData.beatmap:currentMapData?currentMapData.beatmap:null}function getPpDisplay(e,t){const a=document.getElementById("ppOverride").value;return t?""===a||null===a?"♥":`${formatScore(Math.round(parseFloat(a)))}pp ♥`:`${formatScore(Math.round(e.pp))}pp`}async function getBackgroundUrl(){const e=document.getElementById("backgroundOverride").value;if(e)return getProxiedImageUrl("background",e);const t=getBeatmapData();if(!t)return"";const a=t.cover,n=`https://assets.ppy.sh/beatmaps/${t.id}/covers/raw.jpg`;try{if((await fetch(n,{method:"HEAD"})).ok)return getProxiedImageUrl("background",n);console.warn("HD background not found, falling back to API cover image.")}catch(e){console.error("Error fetching HD background:",e)}return getProxiedImageUrl("background",a)}function generateHitCountsHtml(e,t){return t?`\n            \x3c!-- LAZER LAYOUT: 300/100/50 - Miss/Slider Ends - Combo/Accuracy --\x3e\n            <div class="hit-count-row">\n                <div class="stat stat-300">\n                    <span class="label">300</span>\n                    <span class="value">${e.c300}</span>\n                </div>\n                <div class="stat stat-100">\n                    <span class="label">100</span>\n                    <span class="value">${e.c100}</span>\n                </div>\n                <div class="stat stat-50">\n                    <span class="label">50</span>\n                    <span class="value">${e.c50}</span>\n                </div>\n            </div>\n            <div class="hit-count-row">\n                <div class="stat stat-miss">\n                    <span class="label">Miss</span>\n                    <span class="value">${e.misses}</span>\n                </div>\n                <div class="stat stat-sliderend">\n                    <span class="label">Slider Ends</span>\n                    <span class="value">${e.cEnds}/${e.cSliders}</span>\n                </div>\n            </div>\n            <div class="hit-count-row">\n                <div class="stat stat-combo">\n                    <span class="label">Combo</span>\n                    <span class="value">${formatScore(e.max_combo)}x</span>\n                </div>\n                <div class="stat stat-accuracy">\n                    <span class="label">Accuracy</span>\n                    <span class="value">${formatAccuracy(e.accuracy)}%</span>\n                </div>\n            </div>\n        `:`\n            \x3c!-- CLASSIC LAYOUT: 300/100 - 50/Miss - Combo/Accuracy --\x3e\n            <div class="hit-count-row">\n                <div class="stat stat-300">\n                    <span class="label">300</span>\n                    <span class="value">${e.c300}</span>\n                </div>\n                <div class="stat stat-100">\n                    <span class="label">100</span>\n                    <span class="value">${e.c100}</span>\n                </div>\n            </div>\n            <div class="hit-count-row">\n                <div class="stat stat-50">\n                    <span class="label">50</span>\n                    <span class="value">${e.c50}</span>\n                </div>\n                <div class="stat stat-miss">\n                    <span class="label">Miss</span>\n                    <span class="value">${e.misses}</span>\n                </div>\n            </div>\n            <div class="hit-count-row">\n                <div class="stat stat-combo">\n                    <span class="label">Combo</span>\n                    <span class="value">${formatScore(e.max_combo)}x</span>\n                </div>\n                <div class="stat stat-accuracy">\n                    <span class="label">Accuracy</span>\n                    <span class="value">${formatAccuracy(e.accuracy)}%</span>\n                </div>\n            </div>\n        `}async function generateScorecardHtml(e,t,a,n,r,s,c,o,d,l){const i=getGradientColour(a.star_rating),u=a.star_rating>6.5?"ffe475":"2c3b43";return smallScorecard?`\n        <div class="top-bar">\n            <div class="header">\n                <div class="map-info">\n                    <div class="map-title">${a.title}</div>\n                    <div class="star-container">\n                        <div class="star-rating" style="background: ${i}; color: #${u}">★ ${a.star_rating.toFixed(2)}&nbsp;</div>\n                        <div class="mapper">\n                            <span class="map-diff">${truncateText(a.difficulty,32)} </span>\n                            <span class="mapped-by">Mapped by: </span>\n                            <span class="mapper">${a.creator}</span>\n                        </div>\n                    </div>\n                </div>\n                <div class="mod-icons">\n                    ${generateModIconsHtml(e.mods)}\n                </div>\n            </div>\n        </div>\n        <div class="bottom-bar">\n            <div class="bottom-section">\n                <div class="rank-badge rank-${e.rank}"></div>\n                <div class="stat stat-combo">\n                    <span class="label">Combo</span>\n                    <span class="value">${formatScore(e.max_combo)}x</span>\n                </div>\n                <div class="stat stat-accuracy">\n                    <span class="label">Accuracy</span>\n                    <span class="value">${formatAccuracy(e.accuracy)}%</span>\n                </div>\n                <div class="performance">\n                    <span class="pp">${r}</span>\n                </div>\n            </div>\n        </div>\n        `:`\n        <div class="top-bar">\n            <div class="header">\n                <div class="map-info">\n                    <div class="map-title">${a.title}</div>\n                    <div class="star-container">\n                        <div class="star-rating" style="background: ${i}; color: #${u}">★ ${a.star_rating.toFixed(2)}&nbsp;</div>\n                        <div class="mapper">\n                            <span class="map-diff">${truncateText(a.difficulty,32)} </span>\n                            <span class="mapped-by">Mapped by: </span>\n                            <span class="mapper">${a.creator}</span>\n                        </div>\n                    </div>\n                </div>\n                <div class="mod-icons">\n                    ${generateModIconsHtml(e.mods)}\n                </div>\n            </div>\n        </div>\n        <div class="middle-section">\n            <div class="background-image">\n                <img class="bg-img" src="" alt="" crossorigin="anonymous">\n            </div>\n            <div class="background-overlay"></div>\n            <div class="main-content">\n                <div class="left-section">\n                    <div class="stats">\n                        <div class="score">Score: ${formatScore(n?e.score:e.classic_score||e.score)}</div>\n                        <div class="hit-counts">\n                            ${generateHitCountsHtml(e,n)}\n                        </div>\n                    </div>\n                </div>\n                <div class="right-section">\n                    <div class="rank-badge rank-${e.rank}"></div>\n                    <div class="performance">\n                        <div></div>\n                        <div class="full-combo">${s}</div>\n                        <div></div>\n                        <div class="pp">${r}</div>\n                        <div class="extra">${c}</div>\n                    </div>\n                </div>\n            </div>\n        </div>\n        <div class="bottom-bar">\n            <div class="bottom-section">\n                <div class="user-info">\n                    <div class="avatar-container">\n                        <img src="${d}" alt="Avatar" class="avatar" crossorigin="anonymous">\n                        <div class="flag" style="background-image: url('./flags/${t.country.toLowerCase()}.png')"></div>\n                    </div>\n                    <div class="user-details">\n                        <div class="username">${t.username}</div>\n                        <div class="user-rank">#${formatScore(t.userRank)}</div>\n                    </div>\n                </div>\n                <div class="leaderboard-details">\n                    <div class="leaderboard">Leaderboard</div>\n                    <div class="leaderboard-rank">#${l}</div>\n                </div>\n            </div>\n        </div>\n    `}async function updateScorecard(){if(!(currentScoreData||currentMapData))return;const e=document.getElementById("extraText").value.replace(/\n/g,"<br>"),t=document.getElementById("fullComboOverride").checked,a=document.getElementById("lazerScoringOverride").checked,n=document.getElementById("unrankedOverride").checked,r=extractScoreData(),s=extractUserData(),c=getBeatmapData();if(!r||!s||!c)return;const o=n?"UNRANKED":formatScore(r.leaderboard),d=a,l=getPpDisplay(r,"loved"===c.status),i=t||currentScoreData&&r.full_combo?"Full Combo!":"",u=await getBackgroundUrl(),m=getProxiedImageUrl("avatar",s.avatarUrl),p=await generateScorecardHtml(r,s,c,d,l,i,e,u,m,o),v=document.getElementById("scorecard-preview");v.innerHTML=`\n        <div id="generated-scorecard" class="scorecard ${smallScorecard?"small-scorecard":"scorecard"}">\n            ${p}\n        </div>\n    `,setTimeout(()=>{const t=v.querySelector(".map-title");if(t){const e=adjustTitleSize(c.title);t.textContent=e}adjustRightSectionSizes(),adjustScorecardHeight(e,""!==i)},50),v.style.display="flex",document.getElementById("placeholder").style.display="none",document.getElementById("saveBtn").disabled=!1;v.querySelector(".background-image img.bg-img")&&applyBackgroundDataUrl(v,u,currentScoreData?"Score render:":"Map render:");v.querySelector(".avatar-container img.avatar")&&applyAvatarDataUrl(v,m,currentScoreData?"Score render:":"Map render:")}function parseModsString(e){if(!e||""===e.trim())return[];return e.split(",").map(e=>e.trim().toUpperCase()).filter(e=>/^[A-Z]{2}$/.test(e)).map(e=>({acronym:e}))}function getScoreOverrides(){return{score:document.getElementById("scoreOverride").value,count300:document.getElementById("count300").value,count100:document.getElementById("count100").value,count50:document.getElementById("count50").value,countMiss:document.getElementById("countMiss").value,countSliderEnds:document.getElementById("countSliderEnds").value,combo:document.getElementById("comboOverride").value,accuracy:document.getElementById("accuracyOverride").value,pp:document.getElementById("ppScoreOverride").value,rank:document.getElementById("rankOverride").value,mods:document.getElementById("modsOverride").value,leaderboard:document.getElementById("leaderboardOverride").value}}function getUserOverrides(){return{username:document.getElementById("usernameOverride").value,userRank:document.getElementById("userRankOverride").value,avatarUrl:document.getElementById("avatarUrlOverride").value}}function setStatus(e,t){const a=document.getElementById("status");a.textContent=e,a.className=`status-${t}`}async function fetchScoreData(e){try{setStatus("Loading score data...","loading");const t=await fetch(`/api/score/${e}`);if(!t.ok)throw new Error("Failed to fetch score data!");const a=await t.json();currentScoreData=a,currentMapData=null;const n=document.getElementById("ppInputGroup"),r=document.getElementById("scoreOverrides");"loved"===a.beatmap.status?n.style.display="block":n.style.display="none",r.style.display="block",populateOverrideFields(a),updateScorecard(),setStatus("Score loaded successfully!","success")}catch(e){console.error("Error fetching score:",e),setStatus(`Error: ${e.message}`,"error"),currentScoreData=null,document.getElementById("scorecard-preview").style.display="none",document.getElementById("placeholder").style.display="block",document.getElementById("scoreOverrides").style.display="none",document.getElementById("saveBtn").disabled=!0}}function populateOverrideFields(e){document.getElementById("scoreOverride").placeholder=formatScore(e.lazer?e.score.score:e.score.classic_score),document.getElementById("count300").placeholder=e.score.c300.toString(),document.getElementById("count100").placeholder=e.score.c100.toString(),document.getElementById("count50").placeholder=e.score.c50.toString(),document.getElementById("countMiss").placeholder=e.score.misses.toString(),document.getElementById("countSliderEnds").placeholder=e.score.cEnds.toString(),document.getElementById("comboOverride").placeholder=e.score.max_combo.toString(),document.getElementById("accuracyOverride").placeholder=formatAccuracy(e.score.accuracy),document.getElementById("ppScoreOverride").placeholder=Math.round(e.score.pp).toString(),document.getElementById("leaderboardOverride").placeholder=e.score.leaderboard.toString();const t=e.score.mods.map(e=>e.acronym).join(",");document.getElementById("modsOverride").placeholder=t||"No mods",document.getElementById("usernameOverride").placeholder=e.user.username,document.getElementById("userRankOverride").placeholder=e.user.user_rank.toString(),document.getElementById("avatarUrlOverride").placeholder=e.user.avatar_url,document.getElementById("lazerScoringOverride").checked=e.lazer,toggleSliderEndsInput(e.lazer)}function parseScoreId(e){const t=String(e).trim();if(/^\d+$/.test(t))return t;const a=/^https?:\/\/osu\.ppy\.sh\/scores\/(\d+)(?:[/?#].*)?$/.exec(t);return a?a[1]:null}function parseMapId(e){const t=String(e).trim();if(/^\d+$/.test(t))return t;const a=/^https?:\/\/osu\.ppy\.sh\/beatmapsets\/\d+#\w+\/(\d+)(?:[/?#].*)?$/.exec(t);return a?a[1]:null}function setupScoreValidation(){document.getElementById("scoreId").addEventListener("input",function(){parseScoreId(this.value.trim())?(this.style.borderColor="#4CAF50",this.style.backgroundColor=""):(this.style.borderColor="#f44336",this.style.backgroundColor="#2c1a1dff")});document.getElementById("mapId").addEventListener("input",function(){parseMapId(this.value.trim())?(this.style.borderColor="#4CAF50",this.style.backgroundColor=""):(this.style.borderColor="#f44336",this.style.backgroundColor="#2c1a1dff")});const e=document.getElementById("modsOverride");e.addEventListener("input",function(){let e=this.value.toUpperCase();this.value=e,""===e||/^([A-Z]{2})(,[A-Z]{2})*$/.test(e)||/^[A-Z]{1}$/.test(e)||/^[A-Z]{2},$/.test(e)?(this.style.borderColor="#4CAF50",this.style.backgroundColor=""):e.length>2&&!e.includes(",")&&(this.style.borderColor="#f44336",this.style.backgroundColor="#2c1a1dff")}),e.addEventListener("blur",function(){const e=this.value.toUpperCase();if(""!==e){const t=e.split(",").filter(e=>0===e.length||/^[A-Z]{2}$/.test(e.trim())).map(e=>e.trim()).filter(e=>2===e.length).join(",");this.value=t}""===this.value||/^([A-Z]{2})(,[A-Z]{2})*$/.test(this.value)?(this.style.borderColor="#4CAF50",this.style.backgroundColor=""):(this.style.borderColor="#f44336",this.style.backgroundColor="#2c1a1dff")});document.getElementById("accuracyOverride").addEventListener("input",function(){const e=parseFloat(this.value);e<0&&(this.value=0),e>100&&(this.value=100)});document.getElementById("ppScoreOverride").addEventListener("input",function(){parseFloat(this.value)<0&&(this.value=0)});document.getElementById("scoreOverride").addEventListener("input",function(){const e=parseInt(this.value);e<0&&(this.value=0),e>999999999&&(this.value=999999999)}),["count300","count100","count50","countMiss","countSliderEnds","comboOverride","leaderboardOverride","userRankOverride"].forEach(e=>{const t=document.getElementById(e);t&&t.addEventListener("input",function(){parseInt(this.value)<0&&(this.value=0)})});document.getElementById("usernameOverride").addEventListener("input",function(){this.value.length>15&&(this.value=this.value.substring(0,15))});document.getElementById("avatarUrlOverride").addEventListener("blur",function(){const e=this.value.trim();""===e||e.match(/^https?:\/\/.+\.(jpg|jpeg|png|gif|webp)(\?.*)?$/i)?(this.style.borderColor="#4CAF50",this.style.backgroundColor=""):(this.style.borderColor="#f44336",this.style.backgroundColor="#2c1a1dff")})}function toggleSliderEndsInput(e){const t=document.getElementById("sliderEndsCol");t.style.display=e?"flex":"none"}function getTextWidth(e,t){const a=document.createElement("canvas").getContext("2d");a.font=t;const n=a.measureText(e);return Math.ceil(n.width)}function calculateTitleSpace(){const e=document.querySelectorAll(".mod-icon"),t=760-70*e.length-(e.length>0?20:0);return Math.max(200,t)}function adjustTitleSize(e){const t=document.querySelector(".map-title");if(!t)return e;const a=calculateTitleSpace(),n="600 35px 'Fredoka', cursive";if(getTextWidth(e,n)<=a)return t.className="map-title",e;let r=e;for(;getTextWidth(r+"..",n)>a&&r.length>5;)r=r.slice(0,-1);return t.className="map-title",r.length<e.length?r+"..":r}function adjustRightSectionSizes(){const e=document.querySelector(".scorecard"),t=document.querySelector(".left-section"),a=document.querySelector(".right-section");if(!e||!t||!a)return;const n=e.getBoundingClientRect(),r=t.getBoundingClientRect();a.getBoundingClientRect(),n.width,r.width,document.querySelector(".pp"),document.querySelector(".full-combo")}function calculateRequiredHeight(e,t){let a=0;if(e){const t=e.split("<br>").length;t>2&&(a+=30*(t-2))}if(t){const e=document.querySelector(".right-section");if(e){const t=e.scrollHeight,n=e.clientHeight;t>n&&(a+=Math.max(0,t-n+20))}}return 600+a}function adjustScorecardHeight(e,t){const a=document.querySelector(".scorecard");if(!a)return;const n=calculateRequiredHeight(e,t);a.style.height=`${n}px`}async function saveAsPNG(){await fetch("/api/scorecards/increment",{method:"POST"}),updateCounterDisplay();const e=document.getElementById("generated-scorecard");if(e)try{setStatus("Generating PNG...","loading"),await waitForImages(e),e.querySelector(".background-image");const t=await htmlToImage.toPng(e),a=Date.now().toString().slice(-6),n=`scorecard_${currentScoreData?currentScoreData.user.username:"guest"}_${a}.png`,r=document.createElement("a");r.download=n,r.href=t,document.body.appendChild(r),r.click(),document.body.removeChild(r),setStatus("PNG saved successfully!","success")}catch(e){console.error("Error saving PNG:",e),setStatus(`Error saving PNG: ${e.message}`,"error")}else setStatus("No scorecard to save","error")}function waitForImages(e){const t=e.querySelectorAll("img"),a=e.querySelectorAll('[style*="background-image"]'),n=Array.from(t).map(e=>e.complete&&e.naturalWidth>0?Promise.resolve():new Promise(t=>{const a=setTimeout(()=>{console.warn("Image load timeout:",e.src),t()},5e3);e.onload=()=>{clearTimeout(a),t()},e.onerror=()=>{clearTimeout(a),console.warn("Image failed to load:",e.src),t()}})),r=Array.from(a).map(e=>{const t=window.getComputedStyle(e).backgroundImage;return t&&"none"!==t?new Promise(e=>{const a=new Image;a.onload=()=>{e()},a.onerror=()=>{console.warn("Background image failed:",extractCssBackgroundUrl(t)),e()};const n=t.match(/url\(['"]?([^'"]+)['"]?\)/);n?a.src=n[1]:e()}):Promise.resolve()});return Promise.all([...n,...r])}function toggleDropdown(){const e=document.getElementById("dropdownContent"),t=document.getElementById("arrow");"none"===e.style.display||""===e.style.display?(e.style.display="block",t.textContent="▲"):(e.style.display="none",t.textContent="▼")}updateCounterDisplay(),document.addEventListener("DOMContentLoaded",async function(){try{await loadGradientColours()}catch(e){console.error("Failed to load gradient, using fallback colours")}setupScoreValidation();const e=document.getElementById("scoreId"),t=document.getElementById("mapId"),a=document.getElementById("extraText"),n=document.getElementById("fullComboOverride"),r=document.getElementById("backgroundOverride"),s=document.getElementById("ppOverride"),c=document.getElementById("lazerScoringOverride"),o=document.getElementById("saveBtn"),d=["scoreOverride","count300","count100","count50","countMiss","countSliderEnds","comboOverride","accuracyOverride","ppScoreOverride","rankOverride","modsOverride","leaderboardOverride"].map(e=>document.getElementById(e)),l=["usernameOverride","userRankOverride","avatarUrlOverride"].map(e=>document.getElementById(e));let i;function u(e,t){clearTimeout(i),i=setTimeout(e,t)}e.addEventListener("input",function(){const e=this.value.trim().match(/\d+$/);e&&u(()=>fetchScoreData(e),500)}),t.addEventListener("input",function(){const e=this.value.trim().match(/\d+$/);e&&u(()=>fetchMapData(e),500)}),c.addEventListener("change",function(){toggleSliderEndsInput(this.checked),(currentScoreData||currentMapData)&&(currentScoreData||currentMapData)&&updateScorecard()}),[a,n,r,s,...d,...l,unrankedOverride].forEach(e=>{e&&(e.addEventListener("input",function(){(currentScoreData||currentMapData)&&u(()=>{(currentScoreData||currentMapData)&&updateScorecard()},300)}),"checkbox"!==e.type&&"SELECT"!==e.tagName||e.addEventListener("change",function(){(currentScoreData||currentMapData)&&updateScorecard()}))}),o.addEventListener("click",saveAsPNG)}),document.getElementById("smallScorecardToggle").addEventListener("change",function(){smallScorecard=this.checked,updateScorecard()});